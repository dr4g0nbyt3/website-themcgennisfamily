---
interface Props {
  variant?: 'inline' | 'centered' | 'sidebar';
  showDescription?: boolean;
}

const { variant = 'inline', showDescription = true } = Astro.props;
---

<div class={`newsletter-signup ${variant === 'centered' ? 'text-center' : ''} ${variant === 'sidebar' ? 'bg-soho-white p-6 rounded-xl border border-gray-200' : ''}`}>
  {variant === 'centered' && (
    <svg class="w-12 h-12 text-mcgennis-gold mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
    </svg>
  )}

  {/* Icon for inline variant too */}
  {variant === 'inline' && (
    <svg class="w-10 h-10 text-mcgennis-gold mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
    </svg>
  )}

  <h3 class={`font-display font-bold tracking-tight ${variant === 'centered' ? 'text-3xl text-white mb-4' : 'text-xl text-gray-900 mb-3'}`}>
    Join the McGennis Family Newsletter
  </h3>

  {showDescription && (
    <p class={`font-light leading-relaxed ${variant === 'centered' ? 'text-lg text-gray-300 mb-6 max-w-2xl mx-auto' : 'text-base text-gray-600 mb-4'}`}>
      Get weekly encouragement, recipes, and practical wisdom from our family to yours. Faith, family, and coffee-fueled adventures delivered to your inbox.
    </p>
  )}

  <form
    name="newsletter-signup"
    method="POST"
    data-netlify="true"
    data-netlify-honeypot="bot-field"
    class="newsletter-form"
  >
    {/* Hidden fields for Netlify Forms */}
    <input type="hidden" name="form-name" value="newsletter-signup" />
    <input type="hidden" name="return-url" class="signup-return-url" value="" />

    {/* Honeypot field for spam protection (hidden from users) */}
    <p class="hidden">
      <label>
        Don't fill this out if you're human: <input name="bot-field" />
      </label>
    </p>

    <div class={`flex flex-col sm:flex-row gap-3 ${variant === 'centered' ? 'max-w-xl mx-auto' : ''}`}>
      <div class="flex-1">
        <label for="newsletter-email" class="sr-only">Email address</label>
        <input
          type="email"
          id="newsletter-email"
          name="email"
          required
          placeholder="Enter your email address"
          class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-mcgennis-maroon focus:ring-2 focus:ring-mcgennis-maroon focus:ring-opacity-20 transition-all outline-none text-gray-900"
        />
      </div>
      <button
        type="submit"
        class="px-6 py-3 bg-brass-button brightness-110 hover:brightness-100 text-white font-medium rounded-lg shadow-sm hover:shadow-md transition-all duration-300 whitespace-nowrap"
      >
        Subscribe
      </button>
    </div>

    <p class={`text-xs mt-3 font-light ${variant === 'centered' ? 'text-gray-400' : 'text-gray-500'}`}>
      We respect your privacy. Unsubscribe anytime. No spam, just family updates and inspiration.
    </p>
  </form>
</div>

<style>
  .newsletter-form input[type="email"]:focus {
    outline: none;
  }

  .success-notification {
    animation: slide-in 0.3s ease-out;
  }

  @keyframes slide-in {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
</style>

<script>
  // Handle newsletter form submission
  document.addEventListener('DOMContentLoaded', () => {
    const forms = document.querySelectorAll('.newsletter-form');

    forms.forEach(form => {
      // Set return URL
      const returnUrlInput = form.querySelector('.signup-return-url') as HTMLInputElement;
      if (returnUrlInput) {
        returnUrlInput.value = window.location.href;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form as HTMLFormElement);
        const currentUrl = window.location.href;
        const scrollPosition = window.scrollY;

        try {
          await fetch('/', {
            method: 'POST',
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams(formData as any).toString()
          });

          // Store success state
          sessionStorage.setItem('newsletter_subscribed', 'true');
          sessionStorage.setItem('newsletter_scroll', scrollPosition.toString());
          sessionStorage.setItem('newsletter_return_url', currentUrl);

          // Clear form
          (form as HTMLFormElement).reset();

          // Show success notification
          showSuccessNotification();

        } catch (error) {
          console.error('Form submission error:', error);
          alert('There was an error subscribing. Please try again.');
        }
      });
    });

    function showSuccessNotification(): void {
      const notification = document.createElement('div');
      notification.className = 'success-notification fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
      notification.innerHTML = `
        <div class="flex items-center gap-3">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <div>
            <p class="font-semibold">Successfully subscribed!</p>
            <p class="text-sm opacity-90">Check your email for confirmation.</p>
          </div>
        </div>
      `;
      document.body.appendChild(notification);

      // Remove notification after 5 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }
  });
</script>
